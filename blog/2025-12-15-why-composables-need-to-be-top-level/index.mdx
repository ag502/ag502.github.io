---
slug: why-composables-need-to-be-top-level
title: composableì´ Top Levelì— ìˆì–´ì•¼ í•˜ëŠ” ì´ìœ 
tags: [vue]
unlisted: true
---

ì´ ë¬¸ì„œëŠ” ìƒ‰ì¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
{/* truncate */}

ì•„ë§ˆ composableì´ top levelì— ìˆì–´ì•¼ í•˜ëŠ” ì´ìœ ë¥¼ ë“¤ì–´ë³¸ì ì´ ìˆì„ê²ë‹ˆë‹¤. ê·¼ë° ì™œ ì´ëŸ° ê·œì¹™ì´ ì¤‘ìš”í• ê¹Œìš”?

Composableì„ ë¹„ë™ê¸° í•¨ìˆ˜ë‚˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë‚´ë¶€ì—ì„œ ì„ ì–¸í•œë‹¤ë©´ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì¶”ì í•˜ê¸°ê°€ ê¹Œë‹¤ë¡­ìŠµë‹ˆë‹¤.

## ğŸŒƒ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë¬¸ì œ

Top-level ê·œì¹™ì„ ë”°ë¥´ì§€ ì•Šì•˜ì„ ë•Œ ì–´ë–¤ì¼ì´ ë°œìƒí•˜ëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

```js
import { effectScope, ref, watch } from '@vue/reactivity';

const WAIT_TIME = 1000;

function useInterval(label) {
  const n = ref(0);

  watch(n, (v) => console.log(label, v));
  setInterval(() => n.value++, WAIT_TIME);
}

async function runDemo() {
  const outerScope = effectScope();

  outerScope.run(() => {
    function handleUserInput() {
      // ë¹„ë™ê¸° í˜¸ì¶œ - outerScopeì˜ ì¼ë¶€ë¶„ì´ ì•„ë‹˜
      useInterval('handleUserInput');
    }

    // setTimeoutì€ ë¹„ë™ê¸° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì˜ í˜¸ì¶œì„ ëŒ€ì‹ í•©ë‹ˆë‹¤.
    setTimeout(handleUserInput, 0);
  });

  console.log('Starting task...');
  console.log('Try to stop the effect scope after 3 seconds...');

  // 3ì´ˆ í›„ì— scopeì„ ì¤‘ë‹¨ì‹œí‚µë‹ˆë‹¤
  await wait(3000);

  console.log('Stopping outerScope...');
  outerScope.stop();
  console.log('But the task keeps running! This is a leak.');

  await wait(3000);
}
```

ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.

```
Starting task...
Try to stop the effect scope after 3 seconds...
task-A 1
task-A 2
task-A 3
Stopping outerScope...
But the task keeps running! This is a leak.
task-A 4
task-A 5
task-A 6
```

Composableì€ effect scopeì„ ì •ì§€í–ˆìŒì—ë„ ê³„ì† ì‹¤í–‰ë©ë‹ˆë‹¤. ì´ëŠ” `handleUserInput` í•¨ìˆ˜ê°€ ë¹„ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë¹„ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œë ë•Œ composableì€ `outerScope`ì˜ ë‚´ë¶€ì—ì„œ í˜¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

`outerScope`ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•˜ë©´ ì•„ë˜ì²˜ëŸ¼ ì¶”ì í•˜ê³  ìˆëŠ” ë°˜ì‘í˜• effectê°€ ì—†ìŠµë‹ˆë‹¤.

```
EffectScope {
  detached: false,
  _active: true,
  _on: 0,
  effects: [],
  cleanups: [],
  _isPaused: false,
  parent: undefined
}
```

## ğŸŒƒ í•´ê²°ì±…: Detached Effect Scope

ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” composableì„ ìœ„í•œ detached effect scopeì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

```js
import { effectScope, ref, watch } from '@vue/reactivity';

const WAIT_TIME = 1000;

function useInterval(label) {
  const n = ref(0);

  watch(n, (v) => console.log(label, v));
  setInterval(() => n.value++, WAIT_TIME);
}

async function runDemo() {
  const outerScope = effectScope();

  outerScope.run(() => {
    function handleUserInput() {
      // composableì„ ìœ„í•œ detached effect scopeì„ ìƒì„±í•©ë‹ˆë‹¤.
      const innerScope = effectScope(true);

      innerScope.run(() => useInterval('task-A'));

      setTimeout(() => {
        console.log('Stopping innerScope...');
        innerScope.stop();
        console.log('Task stopped successfully! No leaks.');
      }, WAIT_TIME * 3);
    }

    setTimeout(handleUserInput, 0);
  });

  console.log('Starting task...');
  console.log('Task will run for 3 seconds then stop cleanly...');

  await wait(5000);
  console.log('Stopping outerScope (parent scope)...');
  outerScope.stop();
}
```

ì´ì œ ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.

```
Starting task...
Task will run for 3 seconds then stop cleanly...
task-A 1
task-A 2
Stopping innerScope...
Task stopped successfully! No leaks.
Stopping outerScope (parent scope)...
```

ìœ„ ì½”ë“œì—ì„œ í•µì‹¬ì€ `effectScope(true)`ë¥¼ í˜¸ì¶œí•˜ì—¬ detached scopeì„ ìƒì„±í•œ ê²ƒì…ë‹ˆë‹¤. ì´ scopeì€ ë¶€ëª¨ì™€ ë…ë¦½ì ìœ¼ë¡œ ì¡´ì¬í•©ë‹ˆë‹¤.

## ğŸŒƒ Detached Effect Scopeì´ ì¤‘ìš”í•œ ì´ìœ 

Vue ì»´í¬ë„ŒíŠ¸ì—ì„œ ì´ ë¬¸ì œëŠ” composableì„ ì•„ë˜ì˜ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ í˜¸ì¶œí•  ë•Œ ë°œìƒí•©ë‹ˆë‹¤.

- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
- Promise ì½œë°±
- setTimeout ì½œë°±
- ë¹„ë™ê¸° ì½”ë“œ

ì»´í¬ë„ŒíŠ¸ì˜ effect scopeì€ ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” setup í•¨ìˆ˜ì˜ ë°”ê¹¥ì—ì„œ ìƒì„±ëœ composableì„ clean up í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

Detached scopeì„ ìƒì„±í•¨ìœ¼ë¡œì¨, effectê°€ clean up ë  ë•Œ ë¯¸ì„¸í•˜ê²Œ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆê³  ì¥ì‹œê°„ ì‹¤í–‰ë˜ëŠ” ì‘ì—…ì„ ì¤‘ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`true` ì¸ìëŠ” detached scopeì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ëŠ” ë¶€ëª¨ scopeì´ ì¤‘ì§€ë  ë•Œ ìë™ìœ¼ë¡œ clean up ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
